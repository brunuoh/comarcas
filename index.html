<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Filtrar Comarcas - Planilhas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Filtrar planilhas por Comarca</h1>
  <label for="comarca">Escolha a comarca:</label>
  <select id="comarca"></select>
  <button onclick="gerarArquivoFiltrado()">Baixar planilha filtrada</button>

  <script>
    const nomeArquivo = "modelo-ficha-comarcas.xlsx";
    let workbookOriginal;

    async function carregarArquivo() {
      try {
        const response = await fetch(nomeArquivo);
        const arrayBuffer = await response.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        workbookOriginal = XLSX.read(data, { type: "array" });
        preencherDropdownComarcas();
      } catch (e) {
        console.error("Erro ao carregar o arquivo:", e);
        alert("Erro ao carregar o arquivo Excel. Verifique se ele está no mesmo diretório do HTML.");
      }
    }

    function preencherDropdownComarcas() {
      const baseSheet = workbookOriginal.Sheets["Base"];
      const json = XLSX.utils.sheet_to_json(baseSheet, { defval: "" });
      const colunaComarca = Object.keys(json[0])[0];
      const comarcas = [...new Set(json.map(l => l[colunaComarca].toString().trim()))];
      const select = document.getElementById("comarca");
      comarcas.forEach(c => {
        const option = document.createElement("option");
        option.value = option.textContent = c;
        select.appendChild(option);
      });
    }

    function gerarArquivoFiltrado() {
      const comarcaSelecionada = document.getElementById("comarca").value.trim().toLowerCase();
      const novoWorkbook = XLSX.utils.book_new();
      const planilhasParaManter = ["Ficha1", "Ficha2", "Ficha3", "Ficha4", "Ficha5"];
      const nomesAbas = {
        "Ficha1": "TABELIÕES NOVOS",
        "Ficha2": "DATA DE CORTE",
        "Ficha3": "CPIP",
        "Ficha4": "DESFAZIMENTO",
        "Ficha5": "BENS IGNORADOS - TCA"
      };
      let encontrouAbas = 0;

      planilhasParaManter.forEach(sheetName => {
        const sheet = workbookOriginal.Sheets[sheetName];
        if (!sheet) return;

        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        if (!json.length) return;

        const colunaComarca = Object.keys(json[0]).find(k => k.toLowerCase().includes("comarca"));
        if (!colunaComarca) return;

        const somenteComarca = json.filter(l =>
          l[colunaComarca]?.toString().trim().toLowerCase() === comarcaSelecionada
        );

        if (somenteComarca.length > 0) {
          const novaSheet = XLSX.utils.json_to_sheet(somenteComarca);

          // Marcar cabeçalhos em negrito
          const header = Object.keys(somenteComarca[0]);
          header.forEach((col, idx) => {
            const cellRef = XLSX.utils.encode_cell({ r: 0, c: idx });
            if (!novaSheet[cellRef]) return;
            novaSheet[cellRef].s = {
              font: { bold: true }
            };
          });

          const novoNome = nomesAbas[sheetName] || sheetName;
          XLSX.utils.book_append_sheet(novoWorkbook, novaSheet, novoNome);
          encontrouAbas++;
        }
      });

      if (encontrouAbas === 0) {
        alert(`Nenhuma planilha contém dados para a comarca "${comarcaSelecionada}".`);
        return;
      }

      XLSX.writeFile(novoWorkbook, `Comarca_${comarcaSelecionada}.xlsx`);
    }

    carregarArquivo();
  </script>
</body>
</html>